# ==============================================================================
# TAXY BATCH CALIBRATION MACROS
# ==============================================================================
#
# Advanced calibration macros for multi-tool setups using TAXY AI detection.
# Provides full matrix calibration where each tool is measured relative to
# every other tool for maximum accuracy.
#
# Prerequisites:
#   - [taxy] section configured in printer.cfg
#   - [toolchanger] extension loaded
#   - [tc_config_helper] for saving offsets
#   - taxy-macros.cfg included
#
# Usage:
#   1. TAXY_CAMERA_SETUP TOOL=0           - Initial camera setup
#   2. TAXY_CALIBRATE_ALL_TOOLS_XY        - Full matrix calibration (30 measurements)
#   3. SAVE_CONFIG                        - Persist offsets
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Camera Setup with Reference Tool
# ------------------------------------------------------------------------------

[gcode_macro TAXY_CAMERA_SETUP]
description: Setup TAXY camera and set origin with reference tool
gcode:
    {% set TOOL = params.TOOL|default(0)|int %}

    # Enable calibration mode (disables offsets during calibration)
    SET_CALIBRATION_MODE ENABLE=1 XY=1
    STATUS_KTAMV

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  TAXY CAMERA SETUP (T{TOOL})"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Step 1: Configure server
    RESPOND MSG="Step 1/4: Configuring server..."
    SEND_SERVER_CFG_TAXY

    # Step 2: Calibrate camera (mm/pixel ratio)
    RESPOND MSG="Step 2/4: Calibrating camera (mm/pixel)..."
    CALIB_CAMERA_TAXY

    # Step 3: Find and center nozzle
    RESPOND MSG="Step 3/4: Finding nozzle center..."
    FIND_NOZZLE_CENTER_TAXY

    # Step 4: Set origin (after centering!)
    RESPOND MSG="Step 4/4: Setting origin..."
    SET_ORIGIN_TAXY

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  TAXY CAMERA SETUP COMPLETE!"
    RESPOND MSG="  Next: TAXY_CALIBRATE_XY INITIAL_TOOL={TOOL}"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


# ------------------------------------------------------------------------------
# Single Initial Tool Calibration
# ------------------------------------------------------------------------------

[gcode_macro TAXY_CALIBRATE_XY]
description: Measure XY offsets for all tools relative to initial tool
gcode:
    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
    {% set cam_pos = printer.taxy.camera_center_coordinates|default(none) %}

    # Enable calibration mode
    SET_CALIBRATION_MODE ENABLE=1 XY=1
    STATUS_KTAMV

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  TAXY CALIBRATE XY"
    RESPOND MSG="  Reference: T{INITIAL_TOOL}"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Check camera position is set
    {% if cam_pos is none or cam_pos[0] is none %}
        SET_CALIBRATION_MODE ENABLE=0
        STATUS_READY
        RESPOND TYPE=error MSG="Camera position not set!"
        RESPOND MSG="Run TAXY_CAMERA_SETUP TOOL={INITIAL_TOOL} first"
        {action_raise_error("Run TAXY_CAMERA_SETUP first")}
    {% endif %}

    # Home if needed
    {% if 'xyz' not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    # Configure server
    SEND_SERVER_CFG_TAXY

    # Measure each tool (0-5)
    {% for tool_num in range(6) %}
        {% if tool_num != INITIAL_TOOL %}
            RESPOND MSG=""
            RESPOND MSG="━━━ Measuring T{tool_num} ━━━"

            # Pick up tool
            T{tool_num}
            STATUS_KTAMV

            # Move to camera position
            G0 X{cam_pos[0]} Y{cam_pos[1]} F{printer.taxy.move_speed|default(6000)}
            M400

            # Find nozzle center
            RESPOND MSG="Finding nozzle..."
            FIND_NOZZLE_CENTER_TAXY

            # Get offset from origin
            RESPOND MSG="Measuring offset..."
            GET_OFFSET_TAXY

            # Save offset
            {% set offset = printer.taxy.last_calculated_offset|default([0,0]) %}
            RESPOND MSG="T{tool_num} offset: X={offset[0]} Y={offset[1]}"
            _TAXY_SAVE_XY_OFFSET TOOL={tool_num} INITIAL_TOOL={INITIAL_TOOL}
        {% endif %}
    {% endfor %}

    # Disable calibration mode, restore LEDs
    SET_CALIBRATION_MODE ENABLE=0
    STATUS_READY

    RESPOND MSG=""
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  CALIBRATION COMPLETE!"
    RESPOND MSG="  Run SAVE_CONFIG to persist offsets"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


# ------------------------------------------------------------------------------
# Batch Calibration State Machine
# ------------------------------------------------------------------------------

[gcode_macro _TAXY_BATCH_STATE]
description: State storage for batch XY calibration
variable_current_initial: 0
variable_current_measure: 0
variable_running: 0
variable_total_measurements: 0
gcode:
    RESPOND MSG="Batch state: initial=T{printer['gcode_macro _TAXY_BATCH_STATE'].current_initial} measure=T{printer['gcode_macro _TAXY_BATCH_STATE'].current_measure}"


[delayed_gcode _TAXY_BATCH_CONTINUE]
initial_duration: 0
gcode:
    _TAXY_BATCH_NEXT_MEASURE


[delayed_gcode _TAXY_BATCH_SETUP_NEXT]
initial_duration: 0
gcode:
    _TAXY_BATCH_SETUP_INITIAL


[gcode_macro TAXY_CALIBRATE_ALL_TOOLS_XY]
description: Complete XY calibration - each tool as initial, measure all others (30 measurements)
gcode:
    {% if printer['gcode_macro _TAXY_BATCH_STATE'].running|int == 1 %}
        RESPOND TYPE=error MSG="Batch calibration already running! Use TAXY_BATCH_ABORT to cancel."
        {action_raise_error("Batch calibration already running")}
    {% endif %}

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  TAXY FULL CALIBRATION (ALL TOOLS)"
    RESPOND MSG="  AI-powered nozzle detection"
    RESPOND MSG="  Each tool will be used as initial tool"
    RESPOND MSG="  Total: 6×5 = 30 measurements"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Initialize state
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_initial VALUE=0
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_measure VALUE=0
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=running VALUE=1
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=total_measurements VALUE=0

    # Enable calibration mode
    SET_CALIBRATION_MODE ENABLE=1 XY=1
    STATUS_KTAMV

    # Home if needed
    {% if 'xyz' not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    # Configure server once
    SEND_SERVER_CFG_TAXY

    # Start with first initial tool setup
    _TAXY_BATCH_SETUP_INITIAL


[gcode_macro _TAXY_BATCH_SETUP_INITIAL]
description: Setup current initial tool as reference (called per initial tool)
gcode:
    {% set state = printer['gcode_macro _TAXY_BATCH_STATE'] %}
    {% set initial = state.current_initial|int %}

    {% if initial >= 6 %}
        # All done!
        _TAXY_BATCH_COMPLETE
    {% else %}
        RESPOND MSG=""
        RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        RESPOND MSG="  INITIAL TOOL: T{initial} ({initial + 1}/6)"
        RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

        # Pick up initial tool
        T{initial}
        STATUS_KTAMV

        # Move to approximate camera position if known
        {% set cam_pos = printer.taxy.camera_center_coordinates|default(none) %}
        {% if cam_pos is not none and cam_pos[0] is not none %}
            G0 X{cam_pos[0]} Y{cam_pos[1]} F{printer.taxy.move_speed|default(6000)}
            M400
        {% endif %}

        # Camera calibration only needed ONCE (mm/pixel doesn't change between tools)
        {% if initial == 0 %}
            RESPOND MSG="Calibrating camera (mm/pixel)..."
            CALIB_CAMERA_TAXY
        {% else %}
            RESPOND MSG="Skipping camera calibration (already done with T0)"
        {% endif %}

        RESPOND MSG="Finding nozzle center..."
        FIND_NOZZLE_CENTER_TAXY

        RESPOND MSG="Setting origin for T{initial}..."
        SET_ORIGIN_TAXY

        # Reset measure counter and start measuring
        SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_measure VALUE=0
        UPDATE_DELAYED_GCODE ID=_TAXY_BATCH_CONTINUE DURATION=0.1
    {% endif %}


[gcode_macro _TAXY_BATCH_NEXT_MEASURE]
description: Advance to next measurement or next initial tool
gcode:
    {% set state = printer['gcode_macro _TAXY_BATCH_STATE'] %}
    {% set initial = state.current_initial|int %}
    {% set measure = state.current_measure|int %}

    {% if measure >= 6 %}
        # Done with this initial tool, move to next
        SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_initial VALUE={initial + 1}
        UPDATE_DELAYED_GCODE ID=_TAXY_BATCH_SETUP_NEXT DURATION=0.1
    {% elif measure == initial %}
        # Skip self-measurement
        SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_measure VALUE={measure + 1}
        UPDATE_DELAYED_GCODE ID=_TAXY_BATCH_CONTINUE DURATION=0.1
    {% else %}
        # Measure this tool
        _TAXY_BATCH_MEASURE_ONE
    {% endif %}


[gcode_macro _TAXY_BATCH_MEASURE_ONE]
description: Measure single tool offset (reads fresh camera position)
gcode:
    {% set state = printer['gcode_macro _TAXY_BATCH_STATE'] %}
    {% set initial = state.current_initial|int %}
    {% set measure = state.current_measure|int %}
    {% set total = state.total_measurements|int %}

    # Fresh read of camera position (key for state machine pattern!)
    {% set cam_pos = printer.taxy.camera_center_coordinates %}

    RESPOND MSG=""
    RESPOND MSG="━━━ T{initial}→T{measure}: Measuring ({total + 1}/30) ━━━"

    # Pick up tool to measure
    T{measure}
    STATUS_KTAMV

    # Move to camera position (fresh coordinates!)
    G0 X{cam_pos[0]} Y{cam_pos[1]} F{printer.taxy.move_speed|default(6000)}
    M400

    # Find nozzle center
    RESPOND MSG="Finding nozzle..."
    FIND_NOZZLE_CENTER_TAXY

    # Get offset from origin
    RESPOND MSG="Measuring offset..."
    GET_OFFSET_TAXY

    # Save offset (helper macro reads fresh offset value)
    _TAXY_SAVE_XY_OFFSET TOOL={measure} INITIAL_TOOL={initial}

    # Update counters and continue
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=total_measurements VALUE={total + 1}
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=current_measure VALUE={measure + 1}
    UPDATE_DELAYED_GCODE ID=_TAXY_BATCH_CONTINUE DURATION=0.1


[gcode_macro _TAXY_BATCH_COMPLETE]
description: Finalize batch calibration
gcode:
    {% set state = printer['gcode_macro _TAXY_BATCH_STATE'] %}
    {% set total = state.total_measurements|int %}

    # Return to T0
    T0

    # Disable calibration mode, restore LEDs
    SET_CALIBRATION_MODE ENABLE=0
    STATUS_READY

    # Clear running state
    SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=running VALUE=0

    RESPOND MSG=""
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="  FULL CALIBRATION COMPLETE!"
    RESPOND MSG="  All 6 tools calibrated as initial tools"
    RESPOND MSG="  {total} offset measurements saved"
    RESPOND MSG="  Run SAVE_CONFIG to persist offsets"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


[gcode_macro TAXY_BATCH_ABORT]
description: Abort running batch calibration
gcode:
    {% set state = printer['gcode_macro _TAXY_BATCH_STATE'] %}

    {% if state.running|int == 0 %}
        RESPOND MSG="No batch calibration running"
    {% else %}
        SET_GCODE_VARIABLE MACRO=_TAXY_BATCH_STATE VARIABLE=running VALUE=0
        SET_CALIBRATION_MODE ENABLE=0
        STATUS_READY

        RESPOND TYPE=error MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        RESPOND TYPE=error MSG="  BATCH CALIBRATION ABORTED!"
        RESPOND TYPE=error MSG="  Completed: {state.total_measurements}/30 measurements"
        RESPOND TYPE=error MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    {% endif %}


# ------------------------------------------------------------------------------
# Single Tool Recalibration
# ------------------------------------------------------------------------------

[gcode_macro TAXY_RECALIBRATE_TOOL]
description: Recalibrate XY for a single tool (camera must be set up already)
gcode:
    {% set TOOL = params.TOOL|int %}
    {% set INITIAL_TOOL = params.INITIAL_TOOL|default(0)|int %}
    {% set HEAT = params.HEAT|default(0)|int %}
    {% set HEAT_TEMP = params.HEAT_TEMP|default(150)|int %}

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="Recalibrating T{TOOL}"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Check camera is calibrated
    {% set taxy = printer.taxy|default({}) %}
    {% if not taxy.is_calibrated|default(false) %}
        RESPOND TYPE=error MSG="Camera not calibrated!"
        RESPOND MSG="Run TAXY_CAMERA_SETUP first"
        {action_raise_error("TAXY camera not calibrated")}
    {% endif %}

    # Enable calibration mode
    SET_CALIBRATION_MODE ENABLE=1 XY=1
    STATUS_KTAMV

    # Switch to tool
    T{TOOL}
    STATUS_KTAMV

    # Optional: Heat
    {% if HEAT == 1 %}
        RESPOND MSG="-> Heating T{TOOL} to {HEAT_TEMP}C..."
        M109 S{HEAT_TEMP}
    {% endif %}

    # Move to camera
    RESPOND MSG="-> Moving to camera..."
    MOVE_TO_ORIGIN_TAXY
    M400

    # Preview
    START_PREVIEW_TAXY
    G4 P500

    # Find nozzle
    RESPOND MSG="-> Finding nozzle..."
    FIND_NOZZLE_CENTER_TAXY

    # Get offset
    RESPOND MSG="-> Calculating offset..."
    GET_OFFSET_TAXY

    # Check and save
    _TAXY_CHECK_RESULT TOOL={TOOL}
    _TAXY_SAVE_XY_OFFSET TOOL={TOOL} INITIAL_TOOL={INITIAL_TOOL}

    # Cool down if heated
    {% if HEAT == 1 %}
        M104 T{TOOL} S0
    {% endif %}

    # Disable calibration mode
    SET_CALIBRATION_MODE ENABLE=0
    STATUS_READY

    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND MSG="T{TOOL} recalibrated!"
    RESPOND MSG="Run SAVE_CONFIG to persist"
    RESPOND MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


# ------------------------------------------------------------------------------
# Abort Calibration
# ------------------------------------------------------------------------------

[gcode_macro TAXY_ABORT]
description: Emergency stop - abort calibration
gcode:
    RESPOND TYPE=error MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    RESPOND TYPE=error MSG="CALIBRATION ABORTED!"
    RESPOND TYPE=error MSG="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Disable calibration mode
    SET_CALIBRATION_MODE ENABLE=0

    # Cool down all tools
    {% for t in range(6) %}
        M104 T{t} S0
    {% endfor %}

    # Restore LEDs
    STATUS_READY

    RESPOND MSG="-> Calibration mode OFF"
    RESPOND MSG="-> All heaters OFF"
    RESPOND MSG="-> LEDs restored"


# ------------------------------------------------------------------------------
# Internal Helper Macros
# ------------------------------------------------------------------------------

[gcode_macro _TAXY_CHECK_RESULT]
gcode:
    {% set TOOL = params.TOOL|int %}
    {% set taxy = printer.taxy|default({}) %}
    {% set success = taxy.last_nozzle_center_successful|default("false")|lower == "true" %}

    {% if success %}
        RESPOND MSG="  T{TOOL} nozzle found OK"
    {% else %}
        RESPOND TYPE=error MSG="  T{TOOL} nozzle detection FAILED!"
    {% endif %}


[gcode_macro _TAXY_SAVE_XY_OFFSET]
gcode:
    {% set TOOL = params.TOOL|int %}
    {% set INITIAL_TOOL = params.INITIAL_TOOL|int %}
    {% set taxy = printer.taxy|default({}) %}
    {% set MAX_OFFSET = 2.0 %}

    {% set detection_ok = taxy.last_nozzle_center_successful|default("false")|lower == "true" %}

    {% if not detection_ok %}
        RESPOND TYPE=error MSG="  T{TOOL}: Detection failed - NOT saved"
    {% elif taxy.last_calculated_offset is defined %}
        {% set x_offset = taxy.last_calculated_offset[0] %}
        {% set y_offset = taxy.last_calculated_offset[1] %}

        {% if x_offset|abs > MAX_OFFSET or y_offset|abs > MAX_OFFSET %}
            RESPOND TYPE=error MSG="  T{TOOL}: Offset too large! X={x_offset|round(4)} Y={y_offset|round(4)}"
            RESPOND MSG="  -> NOT saved (check camera)"
        {% else %}
            RESPOND MSG="  T{TOOL} offset: X={x_offset|round(4)} Y={y_offset|round(4)}"
            SAVE_TOOL_XY_OFFSET TOOL={TOOL} X={x_offset} Y={y_offset} INITIAL_TOOL={INITIAL_TOOL}
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="  T{TOOL}: No offset data"
    {% endif %}
